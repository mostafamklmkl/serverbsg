########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################
########################################################################################################################################################################################################

# bs lux

import bs                  
import bsUI
import bsInternal
	
def _onPartyMemberPress(self,clientID,isHost,widget):
    # if we're the host, pop up 'kick' options for all non-host members
    if bsInternal._getForegroundHostSession() is not None:
        kickStr = bs.Lstr(resource='kickText')
    else:
        # kick-votes appeared in build 14248
        if bsInternal._getConnectionToHostInfo().get('buildNumber',0) < 14248:
            return
        kickStr = bs.Lstr(resource='kickVoteText')
    p = bsUI.PopupMenuWindow(position=widget.getScreenSpaceCenter(),
                        scale = 2.3 if bsUI.gSmallUI else 1.65 if bsUI.gMedUI else 1.23,
                        choices=['kickOrg', "hey", "ki", "rem", "good", "k", "ke", "s", "se", "c", "ce", "h", "he", "sh", "she", "p", "pe", "fr", "fre", "uf", "ufe", "hl", "hle", "cel", "cele", "l", "sl", "cam", "end", "luxid", "g", "-", "ban", "unban"],
                        choicesDisplay=[kickStr, "\xF0\x9F\x92\xAC Hey", "\xF0\x9F\x9A\xAA Kick", "\xF0\x9F\x9A\xBD Remove", "\xF0\x9F\x91\x8C Good Job!", "\xF0\x9F\x94\xAA Kill", "\xF0\x9F\x94\xAA Kill All", "\xF0\x9F\x92\xA4 Sleep", "\xF0\x9F\x92\xA4 Sleep All", "\xF0\x9F\x94\xAB Curse", "\xF0\x9F\x94\xAB Curse All", "\xE2\x9D\xA4 Heal", "\xE2\x9D\xA4 Heal All", "\xF0\x9F\x94\xAE Shield", "\xF0\x9F\x94\xAE Shield All", "\xF0\x9F\x92\xAA Punch", "\xF0\x9F\x92\xAA Punch All", "\xF0\x9F\x8C\x8A Freeze", "\xF0\x9F\x8C\x8A Freeze All", "\xF0\x9F\x94\xA5 UnFreeze", "\xF0\x9F\x94\xA5 UnFreeze All", "\xF0\x9F\x91\x95 Headless", "\xF0\x9F\x91\x95 Headless All", "\xF0\x9F\x8E\x8A Celebrate", "\xF0\x9F\x8E\x8A Celebrate All", "\xF0\x9F\x93\x91 List", "\xF0\x9F\x94\x83 Slow/fast", "\xF0\x9F\x94\xAD Camera Mode", "\xF0\x9F\x9A\xA7 End", "\xF0\x9F\x92\xBB Lux ID", "\xF0\x9F\x8E\xAE Mini Game", "#########", "Ban", "Unban"],
                        currentChoice='kickOrg',
                        delegate=self).getRootWidget()
    self._popupType = 'partyMemberPress'
    self._popupPartyMemberClientID = clientID
    self._popupPartyMemberIsHost = isHost 
    
    
def popupMenuSelectedChoice(self,popupWindow,choice):

    if choice == "kickOrg":
        if self._popupPartyMemberIsHost:
            bs.playSound(bs.getSound('error'))
            bs.screenMessage(bs.Lstr(resource='internal.cantKickHostError'),color=(1,0,0))
        else:
            #print self._popupPartyMemberClientID
            result = bsInternal._disconnectClient(self._popupPartyMemberClientID)
            if not result:
                bs.playSound(bs.getSound('error'))
                bs.screenMessage(bs.Lstr(resource='getTicketsWindow.unavailableText'),color=(1,0,0))
                
    elif choice == "ki":
        bsInternal._chatMessage(","+choice+" "+ (str(self._popupPartyMemberClientID)))

    elif choice == "rem":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass

    elif choice == "k":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass

    elif choice == "hey":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(str(client['players'][0]['name']))
                except:
                    pass

    elif choice == "luxid":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass

    elif choice == "good":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
        
    elif choice == "ban":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass

    elif choice == "hey":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(str(client['players'][0]['name']))
                except:
                    pass
                
    elif choice == "unban":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                
    elif choice == "c":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                    
    elif choice == "cel":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                
    elif choice == "fr":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                
    elif choice == "uf":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                    
    elif choice == "s":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                    
    elif choice == "p":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                
    elif choice == "hl":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                    
    elif choice == "h":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                    
    elif choice == "sh":
         for client in bsInternal._getGameRoster():
             if client['clientID'] == self._popupPartyMemberClientID:
                try:
                    bsInternal._chatMessage(","+choice+" "+ str(client['players'][0]['name']))
                except:
                    pass
                
    elif choice == "l":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "cam":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "sl":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "g":
        bsInternal._chatMessage("/"+choice)
        
    elif choice == "help":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "end":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "hle":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "ke":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "fre":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "ce":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "she":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "he":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "se":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "ufe":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "pe":
        bsInternal._chatMessage(","+choice)
        
    elif choice == "cele":
        bsInternal._chatMessage(","+choice)
        
    elif self._popupType == 'menu':
        if choice in ('mute', 'unmute'):
           bsConfig = bs.getConfig()
           bsConfig['Chat Muted'] = (choice == 'mute')
           bs.writeConfig()
           bs.applySettings()
           self._update()
    
    else:
        bs.textWidget(edit=self._textField,text='')
          
bsUI.PartyWindow._onPartyMemberPress = _onPartyMemberPress
bsUI.PartyWindow.popupMenuSelectedChoice = popupMenuSelectedChoice


# menu

import bsUI, bs
from bsUI import *
import random


class Namber():
	serversnamber = 0
namber = Namber()

def _Back(self):
    bs.containerWidget(edit=(self.containee), transition=('outRight'))

response = {"Address": "185.126.200.13","Port": "43150"}
response2 = {"Address": "185.126.200.13","Port": "43151"}
response3 = {"Address": "185.126.200.13","Port": "43152"}
response4 = {"Address": "185.126.200.13","Port": "43153"}
response5 = {"Address": "185.126.200.13","Port": "43154"}
response6 = {"Address": "185.126.200.13","Port": "43155"}
response7 = {"Address": "185.126.200.13","Port": "43156"}
response8 = {"Address": "185.126.200.13","Port": "43157"}
response9 = {"Address": "185.126.200.13","Port": "43158"}
response10 = {"Address": "185.126.200.13","Port": "43159"}
response11 = {"Address": "185.126.200.13","Port": "43160"}
response12 = {"Address": "185.126.200.13","Port": "43161"}
response13 = {"Address": "185.126.200.13","Port": "43162"}
response14 = {"Address": "185.126.200.13","Port": "43163"}
response15 = {"Address": "185.126.200.13","Port": "43164"}
fetchedAddress = response['Address']
fetchedPort = int(response['Port'])
fetchedAddress2 = response2['Address']
fetchedPort2 = int(response2['Port'])
fetchedAddress3 = response3['Address']
fetchedPort3 = int(response3['Port'])
fetchedAddress4 = response4['Address']
fetchedPort4 = int(response4['Port'])
fetchedAddress5 = response5['Address']
fetchedPort5 = int(response5['Port'])
fetchedAddress6 = response6['Address']
fetchedPort6 = int(response6['Port'])
fetchedAddress7 = response7['Address']
fetchedPort7 = int(response7['Port'])
fetchedAddress8 = response8['Address']
fetchedPort8 = int(response8['Port'])
fetchedAddress9 = response9['Address']
fetchedPort9 = int(response9['Port'])
fetchedAddress10 = response10['Address']
fetchedPort10 = int(response10['Port'])
fetchedAddress11 = response11['Address']
fetchedPort11 = int(response11['Port'])
fetchedAddress12 = response12['Address']
fetchedPort12 = int(response12['Port'])
fetchedAddress13 = response13['Address']
fetchedPort13 = int(response13['Port'])
fetchedAddress14 = response14['Address']
fetchedPort14 = int(response14['Port'])
fetchedAddress15 = response15['Address']
fetchedPort15 = int(response15['Port'])

def scon(self):
        bsInternal._connectToParty(fetchedAddress, fetchedPort)
def scon2(self):
        bsInternal._connectToParty(fetchedAddress2, fetchedPort2)
def scon3(self):
        bsInternal._connectToParty(fetchedAddress3, fetchedPort3)
def scon4(self):    
        bsInternal._connectToParty(fetchedAddress4, fetchedPort4)
def scon5(self):
        bsInternal._connectToParty(fetchedAddress5, fetchedPort5)
def scon6(self):  
        bsInternal._connectToParty(fetchedAddress6, fetchedPort6)
def scon7(self):    
        bsInternal._connectToParty(fetchedAddress7, fetchedPort7)
def scon8(self):
        bsInternal._connectToParty(fetchedAddress8, fetchedPort8)
def scon9(self):
        bsInternal._connectToParty(fetchedAddress9, fetchedPort9)
def scon10(self):  
        bsInternal._connectToParty(fetchedAddress10, fetchedPort10)
def scon11(self):
        bsInternal._connectToParty(fetchedAddress11, fetchedPort11)
def scon12(self):    
        bsInternal._connectToParty(fetchedAddress12, fetchedPort12)
def scon13(self):
        bsInternal._connectToParty(fetchedAddress13, fetchedPort13)
def scon14(self): 
        bsInternal._connectToParty(fetchedAddress14, fetchedPort14)
def scon15(self):
        bsInternal._connectToParty(fetchedAddress15, fetchedPort15)


def slist(self):
    self.containee=bs.containerWidget(
        size=(750, 450),
        transition='inScale',
        parent=bsInternal._getSpecialWidget('overlayStack'),
        scale=2.0)

    self.b = bs.buttonWidget(
        parent=self.containee, size=(30, 24),
        label=bs.getSpecialChar('back'),
        color=(1,0,0.02),
        onActivateCall=bs.Call(_Back, self),
        buttonType='backSmall', autoSelect=True,
        position=(70, 340))

    self.b = bs.buttonWidget(
        parent=self.containee, size=(90, 30),
        label="Telegram",
        onActivateCall=bs.Call( bs.openURL,'https://t.me/bslux'),
        buttonType='square', autoSelect=True,
        position=(260, 330))

    self.b = bs.buttonWidget(
        parent=self.containee, size=(90, 30),
        label="Buy VIP",
        onActivateCall=bs.Call( bs.openURL,'https://idpay.ir/bsluxvip/shop/275426'),
        buttonType='square', autoSelect=True,
        position=(380, 330))

    self.sto = bs.scrollWidget(
	    parent=self.containee, position=(40 + 20, 70),
		simpleCullingV=200.0, highlight=False,
        size=(630, 250))
    self.contalllll=bs.containerWidget(
        size=(0, 585),
        transition='inScale', color=(0.2, 0.01, 0.43),
        parent=self.sto,
        scale=2.0)
    
    

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,290),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='FFA 1')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,270),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='FFA 2')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,250),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='FFA SLOW 1')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,230),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='FFA SLOW 2')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,210),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='FFA SMASH 1')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,190),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='FFA SMASH 2')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,170),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='FFA SMASH SLOW 1')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,150),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='FFA SMASH SLOW 2')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,130),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='TEAMS 1')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,110),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='TEAMS SLOW 1')
    
    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,90),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='TEAMS SLOW 2')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,70),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='TEAMS SMASH 1')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,50),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='TEAMS SMASH 2')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,30),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='TEAMS SMASH SLOW 1')

    self.text=bs.textWidget(parent=self.contalllll,
              position=(20,10),
              size=(0, 0),
              scale=0.45,
              color=(255,255,255),
              text='TEAMS SMASH SLOW 2')
    
    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon, self),
        position=(15, 280))
    
    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon2, self),
        position=(15, 260))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon3, self),
        position=(15, 240))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon4, self),
        position=(15, 220))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon5, self),
        position=(15, 200))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon6, self),
        position=(15, 180))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon7, self),
        position=(15, 160))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon8, self),
        position=(15, 140))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon9, self),
        position=(15, 120))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon10, self),
        position=(15, 100))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon11, self),
        position=(15, 80))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon12, self),
        position=(15, 60))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon13, self),
        position=(15, 40))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon14, self),
        position=(15, 20))

    self.b = bs.buttonWidget(
        parent=self.contalllll, size=(140, 3),
        label="",
        buttonType='square', autoSelect=True,color=(0.356, 0.760, 0.905),
        onActivateCall=bs.Call(scon15, self),
        position=(15, 0))
        

def _refresh(self):
    # clear everything that was there..
    children = self._rootWidget.getChildren()
    for c in children:
        c.delete()

    # alter some default behavior when going through the main menu..
    if not self._inGame:
        bsUtils.gRunningKioskModeGame = False

    # useAutoSelect = False if self._inGame else True
    useAutoSelect = True

    buttonHeight = 45
    buttonWidth = 200
    padding = 10

    tDelay = 0
    tDelayInc = 0
    tDelayPlay = 0

    is_kiosk = bs.getEnvironment()['kioskMode']

    self._r = 'mainMenu'

    env = bs.getEnvironment()
    self._haveQuitButton = (
            env['interfaceType'] == 'large' or bsInternal._isOuyaBuild(
    ) or (env['platform'] == 'windows'
          and env['subplatform'] == 'oculus'))

    self._haveStoreButton = True if not self._inGame else False

    self._haveSettingsButton = True if ((not self._inGame or not env.get(
        'toolbarTest', True)) and not is_kiosk) else False

    self._inputDevice = inputDevice = bsInternal._getUIInputDevice()
    self._inputPlayer = (inputDevice.getPlayer()
                         if inputDevice is not None else None)
    if self._inputPlayer is not None and not self._inputPlayer.exists():
        self._inputPlayer = None
    self._connectedToRemotePlayer = inputDevice.isConnectedToRemotePlayer(
    ) if inputDevice is not None else False

    positions = []
    pIndex = 0

    if self._inGame:

        customMenuEntries = []
        session = bsInternal._getForegroundHostSession()
        if session is not None:
            try:
                customMenuEntries = session.getCustomMenuEntries()
                for c in customMenuEntries:
                    if (type(c) is not dict or not 'label' in c
                            or type(c['label']) not in (str, unicode, bs.Lstr)
                            or 'call' not in c or not callable(c['call'])):
                        raise Exception(
                            "invalid custom menu entry: " + str(c))
            except Exception:
                customMenuEntries = []
                bs.printException(
                    'exception getting custom menu entries for', session)

        self._width = 250
        self._height = 250 if self._inputPlayer is not None else 180
        if is_kiosk and self._inputPlayer is not None: self._height -= 40
        if not self._haveSettingsButton:
            self._height -= 50
        if self._connectedToRemotePlayer:
            # in this case we have a leave *and* a disconnect button
            self._height += 50
        self._height += 50 * (len(customMenuEntries))
        bs.containerWidget(
            edit=self._rootWidget, size=(self._width, self._height),
            scale=2.15 if gSmallUI else 1.6 if gMedUI else 1.0)
        h = 125
        v = (self._height - 80 if self._inputPlayer is not None
             else self._height - 60)
        hOffset = 0
        dhOffset = 0
        vOffset = -50
        for i in range(6 + len(customMenuEntries)):
            positions.append((h, v, 1.0))
            v += vOffset
            h += hOffset
            hOffset += dhOffset

    # not in game
    else:
        global gDidMenuIntro
        if gDidMenuIntro == False:
            tDelay = 2000
            tDelayInc = 20
            tDelayPlay = 1700
            gDidMenuIntro = True

        self._width = 400
        self._height = 200

        accountType = bsInternal._getAccountType(
        ) if bsInternal._getAccountState() == 'SIGNED_IN' else None
        enableAccountButton = True

        if bsInternal._getAccountState() == 'SIGNED_IN':
            accountTypeName = bsInternal._getAccountDisplayString()
            accountTypeIcon = None
            accountTextColor = (1, 1, 1)
        else:
            accountTypeName = bs.Lstr(
                resource='notSignedInText',
                fallbackResource='accountSettingsWindow.titleText')
            accountTypeIcon = None
            accountTextColor = (1, 0.2, 0.2)
        accountTypeIconColor = (1, 1, 1)
        accountTypeCall = self._showAccountWindow
        accountTypeEnableButtonSound = True

        bCount = 4  # play, help, credits, settings
        if enableAccountButton:
            bCount += 1
        if self._haveQuitButton:
            bCount += 1
        if self._haveStoreButton:
            bCount += 1

        if gSmallUI:
            rootWidgetScale = 1.6
            playButtonWidth = buttonWidth * 0.65
            playButtonHeight = buttonHeight * 1.1
            smallButtonScale = 0.51 if bCount > 6 else 0.63
            buttonYOffs = -20
            buttonYOffs2 = -60
            buttonHeight *= 1.3
            buttonSpacing = 1.04
        elif gMedUI:
            rootWidgetScale = 1.3
            playButtonWidth = buttonWidth * 0.65
            playButtonHeight = buttonHeight * 1.1
            smallButtonScale = 0.6
            buttonYOffs = -55
            buttonYOffs2 = -75
            buttonHeight *= 1.25
            buttonSpacing = 1.1
        else:
            rootWidgetScale = 1.0
            playButtonWidth = buttonWidth * 0.65
            playButtonHeight = buttonHeight * 1.1
            smallButtonScale = 0.75
            buttonYOffs = -80
            buttonYOffs2 = -100
            buttonHeight *= 1.2
            buttonSpacing = 1.1

        spc = buttonWidth * smallButtonScale * buttonSpacing

        bs.containerWidget(
            edit=self._rootWidget, size=(self._width, self._height),
            background=False, scale=rootWidgetScale)

        positions = [[self._width * 0.5, buttonYOffs, 1.7]]
        xOffs = self._width * 0.5 - (spc * (bCount - 1) * 0.5) + (spc * 0.5)
        for i in range(bCount - 1):
            positions.append(
                [xOffs + spc * i - 1.0, buttonYOffs + buttonYOffs2,
                 smallButtonScale])

    if not self._inGame:

        # in kiosk mode, provide a button to get back to the kiosk menu
        if bs.getEnvironment()['kioskMode']:
            h, v, scale = positions[pIndex]
            thisBWidth = buttonWidth * 0.4 * scale
            demoMenuDelay = 0 if tDelayPlay == 0 else max(0, tDelayPlay + 100)
            self._demoMenuButton = bs.buttonWidget(
                parent=self._rootWidget,
                position=(self._width * 0.5 - thisBWidth * 0.5, v + 90),
                size=(thisBWidth, 45),
                autoSelect=True, color=(0.45, 0.55, 0.45),
                textColor=(0.7, 0.8, 0.7),
                label=bs.Lstr(resource=self._r + '.demoMenuText'),
                transitionDelay=demoMenuDelay,
                onActivateCall=self._demoMenuPress)
        else:
            self._demoMenuButton = None

        foo = -1 if gSmallUI else 1 if gMedUI else 3

        h, v, scale = positions[pIndex]
        v = v + foo
        gatherDelay = 0 if tDelayPlay == 0 else max(0, tDelayPlay + 100)
        thisH = h - playButtonWidth * 0.5 * scale - 40 * scale
        thisBWidth = buttonWidth * 0.25 * scale
        thisBHeight = buttonHeight * 0.82 * scale
        self._gatherButton = b = bs.buttonWidget(
            parent=self._rootWidget, position=(thisH - thisBWidth * 0.5, v),
            size=(thisBWidth, thisBHeight),
            autoSelect=useAutoSelect, buttonType='square', label='',
            transitionDelay=gatherDelay, onActivateCall=self._gatherPress)
        bs.textWidget(parent=self._rootWidget,
                      position=(thisH, v + buttonHeight * 0.33),
                      size=(0, 0),
                      scale=0.75,
                      transitionDelay=gatherDelay,
                      drawController=b,
                      color=(0.75, 1.0, 0.7),
                      maxWidth=buttonWidth * 0.33,
                      text=bs.Lstr(resource='gatherWindow.titleText'),
                      hAlign='center', vAlign='center')
        iconSize = thisBWidth * 0.6
        bs.imageWidget(parent=self._rootWidget, size=(iconSize, iconSize),
                       drawController=b,
                       transitionDelay=gatherDelay,
                       position=(thisH - 0.5 * iconSize, v + 0.31 * thisBHeight),
                       texture=bs.getTexture('usersButton'))

        # play button
        h, v, scale = positions[pIndex]
        pIndex += 1
        self._startButton = startButton = b = bs.buttonWidget(
            parent=self._rootWidget,
            position=(h - playButtonWidth * 0.5 * scale, v),
            size=(playButtonWidth, playButtonHeight),
            autoSelect=useAutoSelect, scale=scale, textResScale=2.0,
            label=bs.Lstr(resource='playText'),
            transitionDelay=tDelayPlay, onActivateCall=self._playPress)

        bs.containerWidget(
            edit=self._rootWidget, startButton=startButton,
            selectedChild=startButton)

        v = v + foo

        watchDelay = 0 if tDelayPlay == 0 else max(0, tDelayPlay - 100)
        thisH = h + playButtonWidth * 0.5 * scale + 40 * scale
        thisBWidth = buttonWidth * 0.25 * scale
        thisBHeight = buttonHeight * 0.82 * scale
        self._watchButton = b = bs.buttonWidget(
            parent=self._rootWidget, position=(thisH - thisBWidth * 0.5, v),
            size=(thisBWidth, thisBHeight),
            autoSelect=useAutoSelect, buttonType='square', label='',
            transitionDelay=watchDelay, onActivateCall=self._watchPress)

        self.BSLUX = BSLUX = bs.buttonWidget(
            parent=self._rootWidget, position=(thisH - thisBWidth * 0.5 + 100, v),
            size=(thisBWidth, thisBHeight),
            color=(0.356, 0.760, 0.905),
            autoSelect=useAutoSelect, buttonType='square', label='',texture=bs.getTexture('nub'),
            transitionDelay=watchDelay, onActivateCall=bs.Call(slist, self))

        bs.imageWidget(parent=self._rootWidget, size=(iconSize, iconSize),
                       drawController=BSLUX,
                       transitionDelay=watchDelay,
                       position=(thisH - 0.5 * iconSize + 102, v + 0.33 * thisBHeight),
                       texture=bs.getTexture('inventoryIcon'))

        bs.textWidget(parent=self._rootWidget,
                      position=(thisH + 100, v + buttonHeight * 0.33),
                      size=(0, 0),
                      scale=0.75,
                      transitionDelay=watchDelay,
                      color=(0.75, 1.0, 0.7),
                      drawController=b,
                      maxWidth=buttonWidth * 0.33,
                      text="BsLux",
                      hAlign='center', vAlign='center')

        bs.textWidget(parent=self._rootWidget,
                      position=(thisH, v + buttonHeight * 0.33),
                      size=(0, 0),
                      scale=0.75,
                      transitionDelay=watchDelay,
                      color=(0.75, 1.0, 0.7),
                      drawController=b,
                      maxWidth=buttonWidth * 0.33,
                      text=bs.Lstr(resource='watchWindow.titleText'),
                      hAlign='center', vAlign='center')
        iconSize = thisBWidth * 0.55
        bs.imageWidget(parent=self._rootWidget, size=(iconSize, iconSize),
                       drawController=b,
                       transitionDelay=watchDelay,
                       position=(thisH - 0.5 * iconSize, v + 0.33 * thisBHeight),
                       texture=bs.getTexture('tv'))

        if not self._inGame and enableAccountButton:
            thisBWidth = buttonWidth
            h, v, scale = positions[pIndex]
            pIndex += 1
            self._gcButton = gcButton = b = bs.buttonWidget(
                parent=self._rootWidget,
                position=(h - thisBWidth * 0.5 * scale, v),
                size=(thisBWidth, buttonHeight),
                scale=scale, label=accountTypeName,
                autoSelect=useAutoSelect, onActivateCall=accountTypeCall,
                textColor=accountTextColor, icon=accountTypeIcon,
                iconColor=accountTypeIconColor, transitionDelay=tDelay,
                enableSound=accountTypeEnableButtonSound)

            # scattered eggs on easter
            if bsInternal._getAccountMiscReadVal(
                    'easter', False) and not self._inGame:
                iconSize = 32
                iw = bs.imageWidget(parent=self._rootWidget,
                                    position=(h - iconSize * 0.5 + 35, v +
                                              buttonHeight * scale -
                                              iconSize * 0.24 + 1.5),
                                    transitionDelay=tDelay,
                                    size=(iconSize, iconSize),
                                    texture=bs.getTexture('egg2'),
                                    tiltScale=0.0)
            tDelay += tDelayInc
        else:
            self._gcButton = None

        # how-to-play button
        h, v, scale = positions[pIndex]
        pIndex += 1
        self._howToPlayButton = howToPlayButton = b = bs.buttonWidget(
            parent=self._rootWidget,
            position=(h - buttonWidth * 0.5 * scale, v),
            scale=scale, autoSelect=useAutoSelect,
            size=(buttonWidth, buttonHeight),
            label=bs.Lstr(resource=self._r + '.howToPlayText'),
            transitionDelay=tDelay, onActivateCall=self._howToPlay)

        # scattered eggs on easter
        if bsInternal._getAccountMiscReadVal(
                'easter', False) and not self._inGame:
            iconSize = 28
            iw = bs.imageWidget(
                parent=self._rootWidget,
                position=(h - iconSize * 0.5 + 30,
                          v + buttonHeight * scale -
                          iconSize * 0.24 + 1.5),
                transitionDelay=tDelay, size=(iconSize, iconSize),
                texture=bs.getTexture('egg4'),
                tiltScale=0.0)

        # credits button
        tDelay += tDelayInc
        h, v, scale = positions[pIndex]
        pIndex += 1
        self._creditsButton = creditsButton = b = bs.buttonWidget(
            parent=self._rootWidget,
            position=(h - buttonWidth * 0.5 * scale, v),
            size=(buttonWidth, buttonHeight), autoSelect=useAutoSelect,
            label=bs.Lstr(
                resource=self._r + '.creditsText'),
            scale=scale,
            transitionDelay=tDelay,
            onActivateCall=self._credits)
        tDelay += tDelayInc

    # in-game
    else:
        self._startButton = None
        pause()

        # (player name if applicable)
        if self._inputPlayer is not None:
            playerName = self._inputPlayer.getName()
            h, v, scale = positions[pIndex]
            v += 35
            b = bs.textWidget(
                parent=self._rootWidget, position=(h - buttonWidth / 2, v),
                size=(buttonWidth, buttonHeight),
                color=(1, 1, 1, 0.5),
                scale=0.7, hAlign='center', text=bs.Lstr(
                    value=playerName))
        else:
            playerName = ''

        h, v, scale = positions[pIndex]
        pIndex += 1

        b = bs.buttonWidget(
            parent=self._rootWidget, position=(h - buttonWidth / 2, v),
            size=(buttonWidth, buttonHeight),
            scale=scale, label=bs.Lstr(
                resource=self._r + '.resumeText'),
            autoSelect=useAutoSelect, onActivateCall=self._resume)
        bs.containerWidget(edit=self._rootWidget, cancelButton=b)

        # add any custom options defined by the current game
        for entry in customMenuEntries:
            h, v, scale = positions[pIndex]
            pIndex += 1

            # ask the entry whether we should resume when we call
            # it (defaults to true)
            try:
                resume = entry['resumeOnCall']
            except Exception:
                resume = True

            if resume:
                call = bs.Call(self._resumeAndCall, entry['call'])
            else:
                call = bs.Call(entry['call'], bs.WeakCall(self._resume))

            b = bs.buttonWidget(parent=self._rootWidget,
                                position=(h - buttonWidth / 2, v),
                                size=(buttonWidth, buttonHeight),
                                scale=scale, onActivateCall=call,
                                label=entry['label'],
                                autoSelect=useAutoSelect)

        # add a 'leave' button if the menu-owner has a player
        if ((self._inputPlayer is not None or self._connectedToRemotePlayer)
                and not is_kiosk):
            h, v, scale = positions[pIndex]
            pIndex += 1
            b = bs.buttonWidget(parent=self._rootWidget,
                                position=(h - buttonWidth / 2, v),
                                size=(buttonWidth, buttonHeight),
                                scale=scale, onActivateCall=self._leave,
                                label='', autoSelect=useAutoSelect)

            if (playerName != '' and playerName[0] != '<'
                    and playerName[-1] != '>'):
                t = bs.Lstr(resource=self._r + '.justPlayerText',
                            subs=[('${NAME}', playerName)])
            else:
                t = bs.Lstr(value=playerName)
                # t = playerName
            bs.textWidget(
                parent=self._rootWidget,
                position=(h, v + buttonHeight *
                          (0.64 if playerName != '' else 0.5)),
                size=(0, 0),
                text=bs.Lstr(resource=self._r + '.leaveGameText'),
                scale=(0.83 if playerName != '' else 1.0),
                color=(0.75, 1.0, 0.7),
                hAlign='center', vAlign='center', drawController=b,
                maxWidth=buttonWidth * 0.9)
            bs.textWidget(
                parent=self._rootWidget,
                position=(h, v + buttonHeight * 0.27),
                size=(0, 0),
                text=t, color=(0.75, 1.0, 0.7),
                hAlign='center', vAlign='center', drawController=b,
                scale=0.45, maxWidth=buttonWidth * 0.9)

    if self._haveSettingsButton:
        h, v, scale = positions[pIndex]
        pIndex += 1
        self._settingsButton = settingsButton = b = bs.buttonWidget(
            parent=self._rootWidget,
            position=(h - buttonWidth * 0.5 * scale, v),
            size=(buttonWidth, buttonHeight),
            scale=scale, autoSelect=useAutoSelect, label=bs.Lstr(
                resource=self._r + '.settingsText'),
            transitionDelay=tDelay, onActivateCall=self._settings)

    # scattered eggs on easter
    if bsInternal._getAccountMiscReadVal(
            'easter', False) and not self._inGame:
        iconSize = 34
        iw = bs.imageWidget(
            parent=self._rootWidget,
            position=(h - iconSize * 0.5 - 15, v + buttonHeight * scale -
                      iconSize * 0.24 + 1.5),
            transitionDelay=tDelay, size=(iconSize, iconSize),
            texture=bs.getTexture('egg3'),
            tiltScale=0.0)

    tDelay += tDelayInc

    if self._inGame:
        h, v, scale = positions[pIndex]
        pIndex += 1

        # if we're in a replay, we have a 'Leave Replay' button
        if bsInternal._isInReplay():
            b = bs.buttonWidget(
                parent=self._rootWidget,
                position=(h - buttonWidth * 0.5 * scale, v),
                scale=scale, size=(buttonWidth, buttonHeight),
                autoSelect=useAutoSelect, label=bs.Lstr(
                    resource='replayEndText'),
                onActivateCall=self._confirmEndReplay)
        elif bsInternal._getForegroundHostSession() is not None:
            b = bs.buttonWidget(
                parent=self._rootWidget,
                position=(h - buttonWidth * 0.5 * scale, v),
                scale=scale, size=(buttonWidth, buttonHeight),
                autoSelect=useAutoSelect, label=bs.Lstr(
                    resource=self._r + '.endGameText'),
                onActivateCall=self._confirmEndGame)
        # assume we're in a client-session..
        else:
            b = bs.buttonWidget(
                parent=self._rootWidget,
                position=(h - buttonWidth * 0.5 * scale, v),
                scale=scale, size=(buttonWidth, buttonHeight),
                autoSelect=useAutoSelect, label=bs.Lstr(
                    resource=self._r + '.leavePartyText'),
                onActivateCall=self._confirmLeaveParty)

    if self._haveStoreButton:
        thisBWidth = buttonWidth
        h, v, scale = positions[pIndex]
        pIndex += 1

        sb = self._storeButtonInstance = StoreButton(
            parent=self._rootWidget,
            position=(h - thisBWidth * 0.5 * scale, v),
            size=(thisBWidth, buttonHeight),
            scale=scale, onActivateCall=bs.WeakCall(self._onStorePressed),
            saleScale=1.3, transitionDelay=tDelay)
        self._storeButton = storeButton = sb.getButtonWidget()
        iconSize = 55 if gSmallUI else 55 if gMedUI else 70
        iw = bs.imageWidget(
            parent=self._rootWidget,
            position=(h - iconSize * 0.5,
                      v + buttonHeight * scale - iconSize * 0.23),
            transitionDelay=tDelay, size=(iconSize, iconSize),
            texture=bs.getTexture(self._storeCharTex),
            tiltScale=0.0, drawController=storeButton)

        tDelay += tDelayInc
    else:
        self._storeButton = None

    if not self._inGame and self._haveQuitButton:
        h, v, scale = positions[pIndex]
        pIndex += 1
        self._quitButton = quitButton = b = bs.buttonWidget(
            parent=self._rootWidget, autoSelect=useAutoSelect,
            position=(h - buttonWidth * 0.5 * scale, v),
            size=(buttonWidth, buttonHeight),
            scale=scale, label=bs.Lstr(
                resource=self._r +
                         ('.quitText'
                          if 'Mac' in bs.getEnvironment()['userAgentString'] else
                          '.exitGameText')),
            onActivateCall=self._quit, transitionDelay=tDelay)

        # scattered eggs on easter
        if bsInternal._getAccountMiscReadVal('easter', False):
            iconSize = 30
            iw = bs.imageWidget(
                parent=self._rootWidget,
                position=(h - iconSize * 0.5 + 25,
                          v + buttonHeight * scale - iconSize * 0.24 + 1.5),
                transitionDelay=tDelay, size=(iconSize, iconSize),
                texture=bs.getTexture('egg1'),
                tiltScale=0.0)

        # if bsInternal._isOuyaBuild() or _bs._isRunningOnFireTV():
        bs.containerWidget(edit=self._rootWidget, cancelButton=quitButton)
        tDelay += tDelayInc
    else:
        self._quitButton = None

        # if we're not in-game, have no quit button, and this is android,
        # we want back presses to quit our activity
        if (not self._inGame and not self._haveQuitButton
                and 'android' in bs.getEnvironment()['userAgentString']):
            bs.containerWidget(edit=self._rootWidget, onCancelCall=bs.Call(
                QuitWindow, swish=True, back=True))

    # add speed-up/slow-down buttons for replays
    # (ideally this should be part of a fading-out playback bar like most
    # media players but this works for now)
    if bsInternal._isInReplay():
        bSize = 50
        bBuffer = 10
        tScale = 0.75
        if gSmallUI:
            bSize *= 0.6
            bBuffer *= 1.0
            vOffs = -40
            tScale = 0.5
        elif gMedUI:
            vOffs = -70
        else:
            vOffs = -100
        self._replaySpeedText = bs.textWidget(
            parent=self._rootWidget, text=bs.Lstr(
                resource='watchWindow.playbackSpeedText',
                subs=[('${SPEED}', str(1.23))]),
            position=(h, v + vOffs + 7 * tScale),
            hAlign='center', vAlign='center', size=(0, 0),
            scale=tScale)
        # update to current value
        self._changeReplaySpeed(0)
        # keep updating in a timer in case it gets changed elsewhere
        self._changeReplaySpeedTimer = bs.Timer(
            250, bs.WeakCall(self._changeReplaySpeed, 0),
            timeType='real', repeat=True)
        b = bs.buttonWidget(
            parent=self._rootWidget,
            position=(h - bSize - bBuffer, v - bSize - bBuffer + vOffs),
            buttonType='square', size=(bSize, bSize),
            label='', autoSelect=True, onActivateCall=bs.Call(
                self._changeReplaySpeed, -1))
        bs.textWidget(
            parent=self._rootWidget, drawController=b, text='-',
            position=(h - bSize * 0.5 - bBuffer,
                      v - bSize * 0.5 - bBuffer + 5 * tScale + vOffs),
            hAlign='center', vAlign='center', size=(0, 0),
            scale=3.0 * tScale)
        b = bs.buttonWidget(
            parent=self._rootWidget,
            position=(h + bBuffer, v - bSize - bBuffer + vOffs),
            buttonType='square', size=(bSize, bSize),
            label='', autoSelect=True, onActivateCall=bs.Call(
                self._changeReplaySpeed, 1))
        bs.textWidget(
            parent=self._rootWidget, drawController=b, text='+',
            position=(h + bSize * 0.5 + bBuffer,
                      v - bSize * 0.5 - bBuffer + 5 * tScale + vOffs),
            hAlign='center', vAlign='center', size=(0, 0),
            scale=3.0 * tScale)


bsUI.MainMenuWindow._refresh = _refresh

# PRO AND GLOW
import bsUtils
import bs
import bsLobby
import bsInternal
import weakref
import bsSpaz
import random

def _havePro():
    return True
def _haveProOptions():
    return True
    
gRandProfileIndex = 1
gLastWarnTime = 0
gRandomCharIndexOffset = None
gAccountProfileDeviceID = None
    
class Chooser(object):

    def __del__(self):
        # just kill off our base node; the rest should go down with it
        self._textNode.delete()
        
    def __init__(self, vPos, player, lobby):
        
        import bsInternal
        
        self._deekSound = bs.getSound('deek')
        self._clickSound = bs.getSound('click01')
        self._punchSound = bs.getSound('punch01')
        self._swishSound = bs.getSound('punchSwish')
        self._errorSound = bs.getSound('error')
        self._maskTexture = bs.getTexture('characterIconMask')
        self._vPos = vPos
        self._lobby = weakref.ref(lobby)
        self._player = player
        self._inited = False
        self._dead = False
        
        self.glowDict = {}
        self.markers = ['"',"'","^","%",";","`"]

        # load available profiles either from the local config or from the remote device..
        self.reloadProfiles()
        
        # note: this is just our local index out of available teams; *not* the team ID!
        self._selectedTeamIndex = self.getLobby().nextAddTeam

        # store a persistent random character index; we'll use this for the '_random' profile
        # lets use their inputDevice id to seed it.. this will give a persistent character
        # for them between games and will distribute characters nicely if everyone is random
        try: inputDeviceID = self._player.getInputDevice().getID()
        except Exception,e:
            print 'ERROR: exception getting inputDeviceID for lobby-chooser creation:',e
            inputDeviceID = 0
            import traceback
            traceback.print_stack()

        # we want the first device that asks for a chooser to always get spaz as a random character..
        global gRandomCharIndexOffset
        if gRandomCharIndexOffset is None:
            # scratch that.. we now kinda accomplish the same thing with account profiles
            # so lets just be fully random here..
            gRandomCharIndexOffset = random.randrange(1000)

        # to calc our random index we pick a random character out of our unlocked list and then
        # locate that character's index in the full list
        self._randomCharacterIndex = (inputDeviceID+gRandomCharIndexOffset)%len(self.characterNames)
        
        self._randomColor,self._randomHighlight = bsUtils.getPlayerProfileColors(None)

        global gAccountProfileDeviceID
        
        # attempt to pick an initial profile based on what's been stored for this input device
        try:
            inputDevice = self._player.getInputDevice()
            name = inputDevice.getName()
            uniqueID = inputDevice.getUniqueIdentifier()
            self.profileName = bs.getConfig()['Default Player Profiles'][name+' '+uniqueID]
            self.profileIndex = self.profileNames.index(self.profileName)

            # if this one is __account__ and is local and we havn't marked anyone as the account-profile device yet,
            # mark this guy as it. (prevents the next joiner from getting the account profile too)
            if (self.profileName == '__account__' and not inputDevice.isRemoteClient() and gAccountProfileDeviceID is None):
                gAccountProfileDeviceID = inputDeviceID

        # well hmm that didn't work.. pick __account__, _random, or some other random profile..
        except Exception:

            profileNames = self.profileNames
            
            # we want the first local input-device in the game to latch on to the account profile
            if not inputDevice.isRemoteClient() and not inputDevice.isControllerApp():
                if gAccountProfileDeviceID is None and '__account__' in profileNames:
                    gAccountProfileDeviceID = inputDeviceID

            # if this is the designated account-profile-device, try to default to the account profile
            if inputDeviceID == gAccountProfileDeviceID and '__account__' in profileNames:
                self.profileIndex = profileNames.index('__account__')
            else:
                # if this is the controller app, it defaults to using a random profile
                # (since we can pull the random name from the app)
                if inputDevice.isControllerApp():
                    self.profileIndex = profileNames.index('_random')
                else:
                    # if its a client connection, for now just force the account profile if possible..
                    # (need to provide a way for clients to specify/remember their default profile)
                    if inputDevice.isRemoteClient() and '__account__' in profileNames:
                        self.profileIndex = profileNames.index('__account__')
                    else:
                        global gRandProfileIndex
                        # cycle through our non-random profiles once; after that, everyone gets random.
                        while gRandProfileIndex < len(profileNames) and profileNames[gRandProfileIndex] in ('_random','__account__','_edit'):
                            gRandProfileIndex += 1
                        if gRandProfileIndex < len(profileNames):
                            self.profileIndex = gRandProfileIndex
                            gRandProfileIndex += 1
                        else:
                            self.profileIndex = profileNames.index('_random')
                    
            self.profileName = profileNames[self.profileIndex]
            
        self.characterIndex = self._randomCharacterIndex
        self._color = self._randomColor
        self._highlight = self._randomHighlight
        self.ready = False
        self._textNode = bs.newNode('text',
                                    delegate=self,
                                    attrs={'position':(-100,self._vPos),
                                           'maxWidth':160,
                                           'shadow':0.5,
                                           'vrDepth':-20,
                                           'hAlign':'left',
                                           'vAlign':'center',
                                           'vAttach':'top'})

        bsUtils.animate(self._textNode,'scale',{0:0,100:1.0})
        self.icon = bs.newNode('image',
                               owner=self._textNode,
                               attrs={'position':(-130,self._vPos+20),
                                      'maskTexture':self._maskTexture,
                                      'vrDepth':-10,
                                      'attach':'topCenter'})

        bsUtils.animateArray(self.icon,'scale',2,{0:(0,0),100:(45,45)})

        self._setReady(False)

        # set our initial name to '<choosing player>' in case anyone asks..
        self._player.setName(bs.Lstr(resource='choosingPlayerText').evaluate(),real=False)

        self.getGlowingColors()
        
        self.updateFromPlayerProfile()
        self.updatePosition()
        self._inited = True

    def getTeam(self):
        """ return the selected team """
        return self._lobby()._teams[self._selectedTeamIndex]()

    def getLobby(self):
        return self._lobby()
        
    def getGlowingColors(self):
        try:
            for i in self.profileNames:
                for m in self.markers:
                    if m in i.encode('utf-8') and "," in i.encode("utf-8"):
                        code = i.split(",")
                        
                        marker = code[0]
                        cM = float(code[1])
                        hM = float(code[2])
                        stabilizeC = int(code[3])
                        stabilizeH = int(code[4])
                        
                        self.glowDict[marker] = [cM,hM,stabilizeC,stabilizeH]
        except:
            pass

    def updateFromPlayerProfile(self):
        # set character based on profile; otherwise default to our pre-picked random
        try:
            # store the name even though we usually use index (in case the profile list changes)
            self.profileName = self.profileNames[self.profileIndex]
            character = self.profiles[self.profileName]['character']
            # hmmm; at the moment we're not properly pulling the list of available characters
            # from clients, so profiles might use a character not in their list.
            # for now, just go ahead and add the character name to their list as long
            # as we're aware of it
            if character not in self.characterNames and character in bsSpaz.appearances:
                self.characterNames.append(character)
            self.characterIndex = self.characterNames.index(character)
            
            # Glowing profiles ===========================================================================================
            if self.profileName.encode('utf-8')[0] in self.glowDict:
                cM = self.glowDict[self.profileName.encode('utf-8')[0]][0]
                hM = self.glowDict[self.profileName.encode('utf-8')[0]][1]
                stabilizeC = int(self.glowDict[self.profileName.encode('utf-8')[0]][2]) > 0
                stabilizeH = int(self.glowDict[self.profileName.encode('utf-8')[0]][3]) > 0
                self._color, self._highlight = bsUtils.getPlayerProfileColors(self.profileName, profiles=self.profiles)
                
                if not stabilizeC:
                    self._color = (self._color[0]*cM, self._color[1]*cM, self._color[2]*cM)
                else:
                    m = max(self._color)
                    self._color = list(self._color)
                    
                    if self._color[0] == m:
                        self._color[0] = self._color[0]*cM
                    if self._color[1] == m:
                        self._color[1] = self._color[1]*cM
                    if self._color[2] == m:
                        self._color[2] = self._color[2]*cM
                        
                    self._color = tuple(self._color)
                    
                if not stabilizeH:
                    self._highlight = (self._highlight[0]*hM, self._highlight[1]*hM, self._highlight[2]*hM)
                else:
                    m = max(self._highlight)
                    self._highlight = list(self._highlight)
                    
                    if self._highlight[0] == m:
                        self._highlight[0] = self._highlight[0]*hM
                    if self._highlight[1] == m:
                        self._highlight[1] = self._highlight[1]*hM
                    if self._highlight[2] == m:
                        self._highlight[2] = self._highlight[2]*hM
                        
                    self._highlight = tuple(self._highlight)
            else:
                self._color, self._highlight = bsUtils.getPlayerProfileColors(self.profileName, profiles=self.profiles)
            # ==============================================================================================================
            #self._color, self._highlight = bsUtils.getPlayerProfileColors(self.profileName, profiles=self.profiles)
        except Exception as e:
            self.characterIndex = self._randomCharacterIndex
            self._color = self._randomColor
            self._highlight = self._randomHighlight
        self._updateIcon()
        self._updateText()

    def reloadProfiles(self):
        # re-construct our profile index and other stuff since the profile list might have changed

        inputDevice = self._player.getInputDevice()
        isRemote = inputDevice.isRemoteClient()
        isTestInput = True if (inputDevice is not None and inputDevice.getName().startswith('TestInput')) else False
        
        # pull this player's list of unlocked characters
        if isRemote:
            # FIXME - pull this from remote player (but make sure to filter it to ones we've got)
            self.characterNames = ['Spaz']
        else:
            self.characterNames = self.getLobby().characterNamesLocalUnlocked
        
        # if we're a local player, pull our local profiles from the config..
        # otherwise ask the remote-input-device for its profile list
        if isRemote:
            self.profiles = inputDevice._getPlayerProfiles()
        else:
            try:
                self.profiles = dict(bs.getConfig()['Player Profiles'])
            except Exception as e:
                print 'EXC pulling local profiles'
                self.profiles = {}

        # these may have come over the wire from an older (non-unicode/non-json) version..
        # ..make sure they conform to our standards (unicode strings, no tuples, etc)
        self.profiles = bsUtils.jsonPrep(self.profiles)

        # filter out any characters we're unaware of
        for p in self.profiles.items():
            if p[1].get('character','') not in bsSpaz.appearances:
                p[1]['character'] = 'Spaz'
        
        # add in a random one so we're ok even if there's no user-created profiles
        self.profiles['_random'] = {}

        # for local devices, add it an 'edit' option which will pop up the profile window
        if not isRemote and not isTestInput:
            self.profiles['_edit'] = {}
            
        # build a sorted name list we can iterate through
        self.profileNames = self.profiles.keys()
        self.profileNames.sort(key=lambda x:x.lower())
            
        try:
            self.profileIndex = self.profileNames.index(self.profileName)
        except Exception:
            self.profileIndex = 0
            self.profileName = self.profileNames[self.profileIndex]

    def updatePosition(self):
        # hmmm this shouldnt be happening..
        if not self._textNode.exists():
            'Err: chooser text nonexistant..'
            import traceback
            traceback.print_stack()
            return
        spacing = 350
        offs = spacing*-0.5*len(self.getLobby()._teams) + spacing*self._selectedTeamIndex + 250
        if len(self.getLobby()._teams) > 1: offs -= 35
        curPosition = self._textNode.position
        bsUtils.animateArray(self._textNode,'position',2,{0:self._textNode.position,100:(-100+offs,self._vPos+23)})
        bsUtils.animateArray(self.icon,'position',2,{0:self.icon.position,100:(-130+offs,self._vPos+22)})
        
    def getCharacterName(self):
        return self.characterNames[self.characterIndex]
    
    def _doNothing(self):
        pass

    def _getName(self,full=False):
        nameRaw = name = self.profileNames[self.profileIndex]
        clamp = False
        if name == '_random':
            try: inputDevice = self._player.getInputDevice()
            except Exception: inputDevice = None
            if inputDevice is not None:
                name = inputDevice._getDefaultPlayerName()
            else:
                name = 'Invalid'
            if not full:
                clamp = True
        elif name == '__account__':
            try: inputDevice = self._player.getInputDevice()
            except Exception: inputDevice = None
            if inputDevice is not None:
                name = inputDevice._getAccountName(full)
            else:
                name = 'Invalid'
            if not full:
                clamp = True
        elif name == '_edit':
            # FIXME - this causes problems as an Lstr, but its ok to explicitly translate for now
            # since this is only shown on the host.
            name = bs.Lstr(resource='createEditPlayerText',fallbackResource='editProfileWindow.titleNewText').evaluate()
        else:
            # if we have a regular profile marked as global with an icon, use it (for full only)
            if full:
                try:
                    if self.profiles[nameRaw].get('global',False):
                        icon = bs.uni(self.profiles[nameRaw]['icon'] if 'icon' in self.profiles[nameRaw] else bs.getSpecialChar('logo'))
                        name = icon+name
                except Exception:
                    bs.printException('Error applying global icon')
            else:
                # we now clamp non-full versions of names so there's at least some hope of reading them in-game
                clamp = True
        try:
            for i in self.markers:
                if i in name:
                    name = name.replace(i,"")
        except:
            pass 
        if clamp:
            # in python < 3.5 some unicode chars can have length 2, so we need
            # to convert to raw int vals for safe trimming
            nameChars = bs.uniToInts(name)
            if len(nameChars) > 10:
                name = bs.uniFromInts(nameChars[:10])+'...'
        return name

    def _setReady(self,ready):

        import bsInternal
        
        profileName = self.profileNames[self.profileIndex]

        # handle '_edit' as a special case
        if profileName == '_edit' and ready:
            import bsUI
            with bs.Context('UI'):
                bsUI.PlayerProfilesWindow(inMainMenu=False)
                # give their input-device UI ownership too
                # (prevent someone else from snatching it in crowded games)
                bsInternal._setUIInputDevice(self._player.getInputDevice())
            return
        
        if not ready:
            self._player.assignInputCall('leftPress',bs.Call(self.handleMessage,bsLobby.ChangeMessage('team',-1)))
            self._player.assignInputCall('rightPress',bs.Call(self.handleMessage,bsLobby.ChangeMessage('team',1)))
            self._player.assignInputCall('bombPress',bs.Call(self.handleMessage,bsLobby.ChangeMessage('character',1)))
            self._player.assignInputCall('upPress',bs.Call(self.handleMessage,bsLobby.ChangeMessage('profileIndex',-1)))
            self._player.assignInputCall('downPress',bs.Call(self.handleMessage,bsLobby.ChangeMessage('profileIndex',1)))
            self._player.assignInputCall(('jumpPress','pickUpPress','punchPress'), bs.Call(self.handleMessage,bsLobby.ChangeMessage('ready',1)))
            self.ready = False
            self._updateText()
            self._player.setName('untitled',real=False)
        else:
            self._player.assignInputCall(('leftPress','rightPress', 'upPress','downPress',
                                          'jumpPress','bombPress','pickUpPress'),self._doNothing)
            self._player.assignInputCall(('jumpPress','bombPress','pickUpPress','punchPress'),
                                         bs.Call(self.handleMessage,bsLobby.ChangeMessage('ready',0)))

            # store the last profile picked by this input for reuse
            inputDevice = self._player.getInputDevice()
            name = inputDevice.getName()
            uniqueID = inputDevice.getUniqueIdentifier()
            try: deviceProfiles = bs.getConfig()['Default Player Profiles']
            except Exception: deviceProfiles = bs.getConfig()['Default Player Profiles'] = {}

            # make an exception if we have no custom profiles and are set to random;
            # in that case we'll want to start picking up custom profiles if/when one is made
            # so keep our setting cleared
            haveCustomProfiles = True if [p for p in self.profiles if p not in ('_random','_edit','__account__')] else False
            if profileName == '_random' and not haveCustomProfiles:
                try: del(deviceProfiles[name+' '+uniqueID])
                except Exception: pass
            else:
                deviceProfiles[name+' '+uniqueID] = profileName
            bs.writeConfig()

            # set this player's short and full name
            self._player.setName(self._getName(),self._getName(full=True),real=True)
            self.ready = True
            self._updateText()

            # inform the session that this player is ready
            bs.getSession().handleMessage(bsLobby.PlayerReadyMessage(self))
                
    def handleMessage(self, msg):

        if isinstance(msg, bsLobby.ChangeMessage):

            # if we've been removed from the lobby, ignore this stuff
            if self._dead:
                print "WARNING: chooser got bsLobby.ChangeMessage after dying"
                return
            
            if not self._textNode.exists():
                bs.printError('got bsLobby.ChangeMessage after nodes died')
                return
            
            if msg.what == 'team':
                if len(self.getLobby()._teams) > 1: bs.playSound(self._swishSound)
                self._selectedTeamIndex = (self._selectedTeamIndex + msg.value) % len(self.getLobby()._teams)
                self._updateText()
                self.updatePosition()
                self._updateIcon()

            elif msg.what == 'profileIndex':
                if len(self.profileNames) == 1:
                    # this should be pretty hard to hit now with automatic local accounts..
                    bs.playSound(bs.getSound('error'))
                else:
                    # pick the next player profile and assign our name and character based on that
                    bs.playSound(self._deekSound)
                    self.profileIndex = (self.profileIndex + msg.value) % len(self.profileNames)
                    self.updateFromPlayerProfile()
                
            elif msg.what == 'character':
                bs.playSound(self._clickSound)
                # update our index in our local list of characters
                self.characterIndex = (self.characterIndex + msg.value) % len(self.characterNames)
                self._updateText()
                self._updateIcon()

            elif msg.what == 'ready':

                forceTeamSwitch = False
                
                # team auto-balance kicks us to another team if we try to
                # join the team with the most players
                if not self.ready:
                    try:
                        if bs.getConfig().get('Auto Balance Teams', False):
                            lobby = self.getLobby()
                            if len(lobby._teams) > 1:
                                session = bs.getSession()
                                # first, calc how many players are on each team
                                # ..we need to count both active players and
                                # choosers that have been marked as ready.
                                teamPlayerCounts = {}
                                for team in lobby._teams:
                                    teamPlayerCounts[team().getID()] = len(team().players)
                                for chooser in lobby.choosers:
                                    if chooser.ready:
                                        teamPlayerCounts[chooser.getTeam().getID()] += 1
                                largestTeamSize = max(teamPlayerCounts.values())
                                smallestTeamSize = min(teamPlayerCounts.values())
                                # force switch if we're on the biggest team and there's a smaller one available
                                if largestTeamSize != smallestTeamSize and teamPlayerCounts[self.getTeam().getID()] >= largestTeamSize:
                                    forceTeamSwitch = True
                    except Exception:
                        bs.printException('auto balance error')

                if forceTeamSwitch:
                    bs.playSound(self._errorSound)
                    self.handleMessage(bsLobby.ChangeMessage('team', 1))
                else:
                    bs.playSound(self._punchSound)
                    self._setReady(msg.value)

    def _updateText(self):

        if self.ready:
            # once we're ready, we've saved the name, so lets ask the system for it
            # so we get appended numbers and stuff
            text = bs.Lstr(value=self._player.getName(full=True))
            text = bs.Lstr(value='${A} (${B})',subs=[('${A}',text),('${B}',bs.Lstr(resource='readyText'))])
        else:
            text = bs.Lstr(value=self._getName(full=True))

        canSwitchTeams = len(self.getLobby()._teams) > 1

        # flash as we're coming in
        finColor = bs.getSafeColor(self.getColor())+(1,)
        if not self._inited:
            bsUtils.animateArray(self._textNode,'color',4,{150:finColor,250:(2,2,2,1),350:finColor})
        else:
            # blend if we're in teams mode; switch instantly otherwise
            if canSwitchTeams:
                bsUtils.animateArray(self._textNode,'color',4,{0:self._textNode.color,100:finColor})
            else:
                self._textNode.color = finColor

        self._textNode.text = text

    def getColor(self):
        if self.profileNames[self.profileIndex] == '_edit':
            val = (0,1,0)
        if self.getLobby()._useTeamColors:
            val =  self.getLobby()._teams[self._selectedTeamIndex]().color
        else:
            val = self._color
        if len(val) != 3:
            print 'getColor: ignoring invalid color of len',len(val)
            val = (0,1,0)
        return val

    def getHighlight(self):
        if self.profileNames[self.profileIndex] == '_edit':
            return (0,1,0)
        # if we're using team colors we wanna make sure our highlight color
        # isn't too close to any other team's color
        highlight = list(self._highlight)
        if self.getLobby()._useTeamColors:
            for i,teamRef in enumerate(self.getLobby()._teams):
                team = teamRef()
                if i != self._selectedTeamIndex:
                    # find the dominant component of this team's color
                    # and adjust ours so that the component is not super-dominant
                    maxVal = 0
                    maxIndex = 0
                    for j in range(3):
                        if team.color[j] > maxVal:
                            maxVal = team.color[j]
                            maxIndex = j
                    thatColorForUs = highlight[maxIndex]
                    ourSecondBiggest = max(highlight[(maxIndex+1)%3], highlight[(maxIndex+2)%3])
                    diff = (thatColorForUs-ourSecondBiggest)
                    if diff > 0:
                        highlight[maxIndex] -= diff * 0.6
                        highlight[(maxIndex+1)%3] += diff * 0.3
                        highlight[(maxIndex+2)%3] += diff * 0.2
        return highlight

    def getPlayer(self):
        return self._player

    def _updateIcon(self):
        if self.profileNames[self.profileIndex] == '_edit':
            tex = bs.getTexture('black')
            tintTex = bs.getTexture('black')
            self.icon.color = (1,1,1)
            self.icon.texture = tex
            self.icon.tintTexture = tintTex
            self.icon.tintColor = (0,1,0)
            return

        try:
            texName = bsSpaz.appearances[self.characterNames[self.characterIndex]].iconTexture
            tintTexName = bsSpaz.appearances[self.characterNames[self.characterIndex]].iconMaskTexture
        except Exception:
            bs.printException('Error updating char icon list')
            texName = 'neoSpazIcon'
            tintTexName = 'neoSpazIconColorMask'
        
        tex = bs.getTexture(texName)
        tintTex = bs.getTexture(tintTexName)

        self.icon.color = (1,1,1)
        self.icon.texture = tex
        self.icon.tintTexture = tintTex
        c = self.getColor()
        c2 = self.getHighlight()

        canSwitchTeams = len(self.getLobby()._teams) > 1

        # if we're initing, flash
        if not self._inited:
            bsUtils.animateArray(self.icon,'color',3,{150:(1,1,1),250:(2,2,2),350:(1,1,1)})

        # blend in teams mode; switch instantly in ffa-mode
        if canSwitchTeams:
            bsUtils.animateArray(self.icon,'tintColor',3,{0:self.icon.tintColor,100:c})
        else:
            self.icon.tintColor = c

        self.icon.tint2Color = c2

        # store the icon info the the player
        self._player._setIconInfo(texName,tintTexName,c,c2)
      

      
bsUtils._havePro = _havePro
bsUtils._haveProOptions = _haveProOptions
bsLobby.Chooser = Chooser
